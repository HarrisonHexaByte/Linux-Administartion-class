#!/usr/bin/env bash
# Use the system's environment to run bash safely.

#
# Basic Cyber Security Hardening Script for CentOS 7/8
# WARNING: Always test in a VM or lab server before using on production.
#

set -euo pipefail
# -e  Exit script immediately if a command fails
# -u  Treat unset variables as errors
# -o pipefail  Causes pipes to return the exit status of the first failed command
# This prevents half-executed scripts and silently ignored failures.

### 0. Safety checks ###########################################################

if [[ $EUID -ne 0 ]]; then
    # Check if script is run as root; security tools require root privileges.
    echo "[-] This script must be run as root."
    exit 1
fi

echo "[+] Starting basic hardening for CentOS..."

# Detect CentOS version (7 vs 8) by querying the centos-release package.
CENTOS_VER=$(rpm -q --queryformat '%{VERSION}' centos-release 2>/dev/null || echo "unknown")
echo "[+] Detected CentOS version: $CENTOS_VER"

### 1. System update & useful tools ###########################################

echo "[+] Updating system and installing basic tools..."

# Detect if system uses dnf (CentOS 8) or yum (CentOS 7)
if command -v dnf >/dev/null 2>&1; then
    PKG_MGR="dnf"
else
    PKG_MGR="yum"
fi

# Update all installed packages (very important for security).
$PKG_MGR -y update

# Install Extra Packages for Enterprise Linux (EPEL repo).
$PKG_MGR -y install epel-release

# Install basic tools useful in admin/security.
$PKG_MGR -y install vim-enhanced git wget curl net-tools htop fail2ban

echo "[+] Base packages installed."

### 2. Enable automatic security updates ######################################

echo "[+] Setting up automatic (security) updates..."

# CentOS 7 method (yum-cron)
if [[ "$PKG_MGR" == "yum" ]]; then
    $PKG_MGR -y install yum-cron
    # Enable automatic installs
    sed -i.bak 's/^apply_updates = .*/apply_updates = yes/' /etc/yum/yum-cron.conf
    # Security-only update mode
    sed -i.bak 's/^update_cmd = .*/update_cmd = security/' /etc/yum/yum-cron.conf
    systemctl enable yum-cron
    systemctl start yum-cron

# CentOS 8+ method (dnf-automatic)
else
    $PKG_MGR -y install dnf-automatic
    # Turn on automatic updates
    sed -i.bak 's/apply_updates = .*/apply_updates = yes/' /etc/dnf/automatic.conf
    systemctl enable --now dnf-automatic.timer
fi

echo "[+] Automatic updates configured."

### 3. Firewall configuration (firewalld) #####################################

echo "[+] Configuring firewalld..."

# Install, enable, and start firewalld.
$PKG_MGR -y install firewalld
systemctl enable firewalld
systemctl start firewalld

# Allow SSH so you don’t lock yourself out.
firewall-cmd --permanent --add-service=ssh

# Optional web ports (commented until needed).
# firewall-cmd --permanent --add-service=http
# firewall-cmd --permanent --add-service=https

# Reload firewall to apply changes.
firewall-cmd --reload

echo "[+] Firewalld configured. SSH allowed; HTTP/HTTPS commented by default."

### 4. SSH hardening ##########################################################

echo "[+] Hardening SSH configuration..."

SSHD_CONFIG="/etc/ssh/sshd_config"

# Backup SSH config so you can recover if locked out.
cp "$SSHD_CONFIG" "${SSHD_CONFIG}.bak.$(date +%F_%T)"

# Force SSH protocol 2 (more secure than deprecated protocol 1).
sed -i 's/^#\?Protocol .*/Protocol 2/' "$SSHD_CONFIG"

# Disable X11 forwarding (attack vector for GUI tunneling).
sed -i 's/^#\?X11Forwarding .*/X11Forwarding no/' "$SSHD_CONFIG"

# Disable DNS lookups for connecting clients (prevents delays & spoofing).
sed -i 's/^#\?UseDNS .*/UseDNS no/' "$SSHD_CONFIG"

# Prevent empty passwords from being used.
sed -i 's/^#\?PermitEmptyPasswords .*/PermitEmptyPasswords no/' "$SSHD_CONFIG"

# Disable direct root login — critical for strong security.
if grep -q "^PermitRootLogin" "$SSHD_CONFIG"; then
    sed -i 's/^PermitRootLogin.*/PermitRootLogin no/' "$SSHD_CONFIG"
else
    echo "PermitRootLogin no" >> "$SSHD_CONFIG"
fi

# OPTIONAL (commented): disable password authentication entirely.
# This requires SSH keys to be already working.
# sed -i 's/^PasswordAuthentication.*/PasswordAuthentication no/' "$SSHD_CONFIG"

# Apply SSH changes.
systemctl reload sshd
echo "[+] SSH configuration hardened (root login disabled)."

### 5. Fail2ban configuration (protect SSH) ###################################

echo "[+] Configuring fail2ban for SSH..."

# Create fail2ban jail.local file.
cat >/etc/fail2ban/jail.local <<'EOF'
[DEFAULT]
bantime  = 1h           # How long an attacker is banned
findtime = 10m          # Time window to track login attempts
maxretry = 5            # How many failed attempts allowed
backend  = systemd      # Uses system logs
destemail = root@localhost
sender = fail2ban@localhost
mta = sendmail

[sshd]
enabled  = true         # Turn on SSH protection
port     = ssh          # Monitors SSH port
filter   = sshd         # Use the default SSH filter rules
logpath  = /var/log/secure
maxretry = 5
EOF

# Enable and start fail2ban service.
systemctl enable fail2ban
systemctl restart fail2ban

echo "[+] Fail2ban enabled and protecting SSH."

### 6. Password policy & lockout ##############################################

echo "[+] Setting basic password policy..."

# Enforce password aging (90 days, warning at 7 days, etc.).
sed -i.bak \
    -e 's/^PASS_MAX_DAYS.*/PASS_MAX_DAYS   90/' \
    -e 's/^PASS_MIN_DAYS.*/PASS_MIN_DAYS   1/' \
    -e 's/^PASS_WARN_AGE.*/PASS_WARN_AGE   7/' \
    /etc/login.defs

# Enforce password complexity.
if grep -q "pam_pwquality.so" /etc/pam.d/system-auth; then
    sed -i 's/^password    requisite     pam_pwquality.so.*/password    requisite     pam_pwquality.so try_first_pass local_users_only retry=3 authtok_type=/' /etc/pam.d/system-auth
else
    echo "password    requisite     pam_pwquality.so try_first_pass local_users_only retry=3 authtok_type=" >> /etc/pam.d/system-auth
fi

echo "[+] Password policy updated (aging + basic complexity)."

### 7. Enable and configure auditd ############################################

echo "[+] Enabling auditd..."

# Install audit daemon (tracks important file accesses).
$PKG_MGR -y install audit

# Enable and start audit logging.
systemctl enable auditd
systemctl start auditd

# Add audit rules to watch critical config files.
cat >/etc/audit/rules.d/hardening.rules <<'EOF'
-w /etc/passwd -p wa -k passwd_changes      # Watch for writes/changes to passwd
-w /etc/shadow -p wa -k shadow_changes      # Watch password hashes file
-w /etc/sudoers -p wa -k sudoers_changes    # Watch sudo permissions file
EOF

# Load audit rules.
augenrules --load

echo "[+] Auditd enabled with some basic rules."

### 8. Network sysctl hardening ###############################################

echo "[+] Applying basic network sysctl hardening..."

SYSCTL_FILE="/etc/sysctl.d/99-hardening.conf"

# Create sysctl configuration file with network protections.
cat >"$SYSCTL_FILE" <<'EOF'
# Enable SYN cookies to prevent SYN flood attacks
net.ipv4.tcp_syncookies = 1

# Ignore broadcast ICMP (prevents Smurf attacks)
net.ipv4.icmp_echo_ignore_broadcasts = 1

# Disable source routing (prevents attackers specifying return path)
net.ipv4.conf.all.accept_source_route = 0
net.ipv4.conf.default.accept_source_route = 0

# Disable ICMP redirects (prevents MITM spoofing)
net.ipv4.conf.all.accept_redirects = 0
net.ipv4.conf.default.accept_redirects = 0

# Log suspicious / malformed packets
net.ipv4.conf.all.log_martians = 1
net.ipv4.conf.default.log_martians = 1
EOF

# Apply the changes system-wide.
sysctl --system

echo "[+] Network sysctl hardening applied."

### 9. Summary #################################################################

echo
echo "==================== HARDENING COMPLETE ===================="
echo "Changes made:"
echo " - System updated and basic tools installed"
echo " - Automatic security updates enabled"
echo " - Firewalld enabled; SSH allowed (HTTP/HTTPS commented out)"
echo " - SSH locked down (root login disabled, safer defaults)"
echo " - Fail2ban protecting SSH"
echo " - Password aging & complexity updated"
echo " - Auditd enabled with basic file watches"
echo " - Network sysctl hardening applied"
echo
echo "IMPORTANT:"
echo " - Review /etc/ssh/sshd_config before locking out password auth."
echo " - Test everything in a VM or lab box before using in production."
echo "============================================================"

